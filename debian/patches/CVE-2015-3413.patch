Description: Don't crash HHVM with null-byte-ridden DOMDocument paths (CVE-2015-3413)
Author: Max Wang
Origin: https://github.com/facebook/hhvm/commit/02a7a8f086c9181002fca0f0d9cef42963fdf46a

diff --git a/hphp/runtime/ext/domdocument/ext_domdocument.cpp b/hphp/runtime/ext/domdocument/ext_domdocument.cpp
--- a/hphp/runtime/ext/domdocument/ext_domdocument.cpp
+++ b/hphp/runtime/ext/domdocument/ext_domdocument.cpp
@@ -713,7 +713,7 @@
       // entity loading path, which is locked down by default for security
       // reasons.
       auto stream = File::Open(file_dest, "rb");
-      if (!stream->isInvalid()) {
+      if (stream && !stream->isInvalid()) {
         ctxt = xmlCreateIOParserCtxt(nullptr, nullptr,
                                      libxml_streams_IO_read,
                                      libxml_streams_IO_close,
diff --git a/hphp/test/slow/domdocument_doctype_isset.php b/hphp/test/slow/ext_domdocument/domdocument_doctype_isset.php
rename from hphp/test/slow/domdocument_doctype_isset.php
rename to hphp/test/slow/ext_domdocument/domdocument_doctype_isset.php
diff --git a/hphp/test/slow/domdocument_doctype_isset.php.expect b/hphp/test/slow/ext_domdocument/domdocument_doctype_isset.php.expect
rename from hphp/test/slow/domdocument_doctype_isset.php.expect
rename to hphp/test/slow/ext_domdocument/domdocument_doctype_isset.php.expect
diff --git a/hphp/test/slow/ext_domdocument/null_byte_filename.php b/hphp/test/slow/ext_domdocument/null_byte_filename.php
new file mode 100644
--- /dev/null
+++ b/hphp/test/slow/ext_domdocument/null_byte_filename.php
@@ -0,0 +1,5 @@
+<?php
+
+$doc = new DOMDocument();
+$doc->load('/etc/fonts/fonts.conf' . chr(0) . 'somethingelse.xml');
+echo $doc->saveXML();
diff --git a/hphp/test/slow/ext_domdocument/null_byte_filename.php.expect b/hphp/test/slow/ext_domdocument/null_byte_filename.php.expect
new file mode 100644
--- /dev/null
+++ b/hphp/test/slow/ext_domdocument/null_byte_filename.php.expect
@@ -0,0 +1 @@
+<?xml version="1.0"?>

